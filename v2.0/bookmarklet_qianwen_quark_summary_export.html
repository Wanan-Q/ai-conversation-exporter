<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>åƒé—®(å¤¸å…‹) - æ€»ç»“å¹¶å¯¼å‡º</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    h1 { color: #333; }
    .info { background: #e8f0fe; padding: 16px; border-radius: 6px; margin: 16px 0; border-left: 4px solid #4285f4; }
    .bookmark { 
      display: inline-block; padding: 12px 24px; background: #4285f4; color: white; 
      text-decoration: none; border-radius: 6px; margin: 10px 0; cursor: move; font-weight: bold;
    }
    .bookmark:hover { background: #3367d6; }
    .step { background: #f5f5f5; padding: 16px; margin: 16px 0; border-radius: 6px; }
    code { background: #eee; padding: 2px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>ğŸ“ æ€»ç»“å¹¶å¯¼å‡ºï¼ˆåƒé—®-å¤¸å…‹ï¼‰</h1>
  <p>å‘é€ã€Œæ€»ç»“å½“å‰å¯¹è¯ï¼Œå¯¹è¯æ¡†ç›´æ¥å›ç­”ã€‚ã€â†’ ç­‰å¾… AI ç”Ÿæˆå®Œæˆ â†’ è‡ªåŠ¨å¯¼å‡ºä¸º Markdown</p>

  <div class="info">
    <strong>âœ¨ é€‚ç”¨åŸŸå</strong>
    <ul style="margin:8px 0;">
      <li>åƒé—® (Qianwen) - qianwen.com/quarkchat/</li>
      <li>é€‚ç”¨äºå¤¸å…‹æµè§ˆå™¨</li>
    </ul>
  </div>

  <div class="step">
    <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>
    <ol>
      <li>å°†ä¸‹æ–¹æŒ‰é’®æ‹–æ‹½åˆ°æµè§ˆå™¨ä¹¦ç­¾æ </li>
      <li>æ‰“å¼€åƒé—®å¤¸å…‹å¯¹è¯é¡µé¢ (qianwen.com/quarkchat/)</li>
      <li>ç‚¹å‡»ä¹¦ç­¾ï¼Œè‡ªåŠ¨å‘é€æ€»ç»“æŒ‡ä»¤å¹¶ç­‰å¾…å®Œæˆåå¯¼å‡º</li>
    </ol>
  </div>
  
  <a class="bookmark" id="sender" href="">ğŸ“ æ€»ç»“å¹¶å¯¼å‡ºåƒé—®å¯¹è¯(å¤¸å…‹)</a>
  
  <p style="margin-top:20px;font-size:0.9em;color:#666;">
    ğŸ’¡ é€šè¿‡ã€Œsubmit-button loadingã€çš„æ˜¾éšåˆ¤æ–­ AI æ˜¯å¦å®Œæˆã€‚æŒ‰ F12 å¯æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚
  </p>

  <script>
    var script = function() {
      var MSG = 'æ€»ç»“å½“å‰å¯¹è¯ï¼Œå¯¹è¯æ¡†ç›´æ¥å›ç­”ã€‚';
      var POLL_MS = 500;
      var WAIT_FOR_START_MS = 15000;
      var MAX_GENERATING_MS = 120000;
      
      if (location.hostname.indexOf('qianwen.com') < 0 || location.pathname.indexOf('/quarkchat') < 0) {
        alert('è¯·åœ¨åƒé—® quarkchat (qianwen.com/quarkchat/) å¯¹è¯é¡µé¢ä½¿ç”¨æ­¤ä¹¦ç­¾');
        return;
      }
      
      var doExport = function(trigger) {
        try {
          var rules = [
            { container: '[class*="message-select-wrapper"]', userPattern: 'question' },
            { container: '[class*="message-select"]', userPattern: 'question' },
            { container: '[class*="message-wrapper"]', userPattern: 'question' },
            { container: '[class*="chat-message"]', userPattern: 'user|question' },
            { container: '[class*="bubble"]', userPattern: 'user|question|right' },
            { container: 'article', userPattern: 'user|question' }
          ];
          var rule = null;
          var exT = function(tb) {
            var rs = tb.querySelectorAll('tr'), md = [];
            for (var r = 0; r < rs.length; r++) {
              var cs = rs[r].querySelectorAll('th, td'), ln = [];
              for (var c = 0; c < cs.length; c++) ln.push((cs[c].innerText || '').trim().replace(/\n+/g, ' ').replace(/\|/g, '\\|'));
              if (ln.length > 0) { md.push('| ' + ln.join(' | ') + ' |'); if (r === 0) md.push('| ' + ln.map(function() { return '---'; }).join(' | ') + ' |'); }
            }
            return md.join('\n');
          };
          var exC = function(p) {
            var c = p.querySelector('code') || p;
            return (c.innerText || '').trim().split('\n').map(function(l) { return l.replace(/^\s*\d+\s+/, ''); }).join('\n');
          };
          var toMd = function(el) {
            var w = function(n) {
              if (!n) return '';
              if (n.nodeType === 1 && n.getAttribute && n.getAttribute('data-c') === 'result_card') return '';
              if (n.nodeType === 1 && n.className && ('' + n.className).indexOf('recommend-query-wrap') >= 0) return '';
              if (n.nodeType === 3) return n.textContent.replace(/\s+/g, ' ');
              if (n.nodeName === 'TABLE') { var t = exT(n); return t ? '\n\n' + t + '\n\n' : ''; }
              if (n.nodeName === 'PRE') {
                var cd = exC(n); if (!cd) return '';
                var ce = n.querySelector('code'), lg = '';
                if (ce && ce.className) { var m = ce.className.match(/language-(\w+)/); if (m) lg = m[1]; }
                if (!lg && /(SELECT|def |import )/.test(cd)) lg = /SELECT/.test(cd) ? 'sql' : 'python';
                return '\n\n```' + lg + '\n' + cd + '\n```\n\n';
              }
              if (/^H[1-6]$/.test(n.nodeName)) { var lv = parseInt(n.nodeName[1]) + 1, hh = ''; for (var i = 0; i < lv; i++) hh += '#'; return '\n\n' + hh + ' ' + wc(n).trim() + '\n\n'; }
              if (n.nodeName === 'P') return wc(n) + '\n';
              if (n.nodeName === 'BR') return '\n';
              if (n.nodeName === 'LI') return '- ' + wc(n).trim() + '\n';
              if (n.nodeName === 'UL' || n.nodeName === 'OL') return '\n' + wc(n);
              if (n.nodeName === 'STRONG' || n.nodeName === 'B') return '**' + wc(n) + '**';
              if (n.nodeName === 'EM' || n.nodeName === 'I') return '*' + wc(n) + '*';
              if (n.nodeName === 'CODE') return '`' + (n.innerText || '').trim() + '`';
              return wc(n);
            };
            var wc = function(n) { if (!n || !n.childNodes) return ''; var o = ''; for (var i = 0; i < n.childNodes.length; i++) o += w(n.childNodes[i]); return o; };
            return w(el).replace(/\n{3,}/g, '\n\n').trim();
          };
          var cs = [];
          for (var r = 0; r < rules.length; r++) {
            rule = rules[r];
            var getRole = function(el, pat) {
              for (var n = el; n && n !== document.body; n = n.parentElement) {
                if (new RegExp(pat).test(n.className || '')) return 'user';
              }
              return 'assistant';
            };
            var es = document.querySelectorAll(rule.container);
            cs = [];
            for (var i = 0; i < es.length; i++) {
              if (es[i].getBoundingClientRect().right < 280) continue;
              var ro = getRole(es[i], rule.userPattern);
              cs.push({ el: es[i], role: ro, top: es[i].getBoundingClientRect().top });
            }
            if (cs.length > 0) break;
          }
          if (cs.length === 0) { alert('æœªæå–åˆ°å¯¹è¯å†…å®¹'); return; }
          cs.sort(function(a, b) { return a.top - b.top; });
          var ms = [];
          for (var i = 0; i < cs.length; i++) {
            var ct = toMd(cs[i].el);
            if (!ct) ct = (cs[i].el.innerText || '').trim();
            if (ct.length > 5) ms.push({ role: cs[i].role, content: ct });
          }
          var mg = [];
          for (var i = 0; i < ms.length; i++) {
            if (mg.length > 0 && mg[mg.length - 1].role === ms[i].role) mg[mg.length - 1].content += '\n\n' + ms[i].content;
            else mg.push(ms[i]);
          }
          if (mg.length > 0 && mg[0].role !== 'user' && mg[0].content.length < 300) mg[0].role = 'user';
          var summaryContent = '';
          var mainMsgs = mg;
          if (mg.length >= 2) {
            var lastUser = mg[mg.length - 2];
            var lastAi = mg[mg.length - 1];
            var cmd = 'æ€»ç»“å½“å‰å¯¹è¯';
            if (lastUser.role === 'user' && lastAi.role === 'assistant' && (lastUser.content.indexOf(cmd) >= 0 || lastUser.content.trim() === cmd + 'ã€‚')) {
              summaryContent = lastAi.content.replace(/\n{3,}/g, '\n\n').trim();
              mainMsgs = mg.slice(0, -2);
            }
          }
          var now = new Date();
          var ts = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2) + '_' + ('0' + now.getHours()).slice(-2) + ('0' + now.getMinutes()).slice(-2) + ('0' + now.getSeconds()).slice(-2);
          var fn = 'Qianwen_Summary_' + ts + '.md';
          var md = '# Qianwen Chat Export (Summary)\n\n> ' + now.toLocaleString('zh-CN') + '\n\n';
          if (summaryContent) {
            md += '# å¯¹è¯æ€»ç»“\n\n' + summaryContent + '\n\n---\n\n';
          }
          for (var i = 0; i < mainMsgs.length; i++) {
            var tx = mainMsgs[i].content.replace(/\n{3,}/g, '\n\n').trim();
            if (mainMsgs[i].role === 'user') md += '# User\n\n' + tx + '\n\n---\n\n';
            else md += '# AI\n\n' + tx + '\n\n';
          }
          var bl = new Blob([md.trim()], { type: 'text/markdown;charset=utf-8' });
          var a = document.createElement('a');
          a.href = URL.createObjectURL(bl);
          a.download = fn;
          a.click();
          URL.revokeObjectURL(a.href);
          var triggerText = trigger || 'æœªçŸ¥';
          console.log('=== å¯¼å‡ºå®Œæˆ [' + triggerText + '] ===');
          alert('å·²å¯¼å‡º ' + mainMsgs.length + ' æ¡æ¶ˆæ¯' + (summaryContent ? 'ï¼ˆå«æ€»ç»“ï¼‰' : '') + '\n\nè§¦å‘æ–¹å¼ï¼š' + triggerText + '\n\n' + fn);
        } catch (e) {
          console.error('Export error:', e);
          alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
        }
      };
      
      var input = document.querySelector('textarea[placeholder*="åƒé—®"]') || document.querySelector('textarea[placeholder*="æé—®"]');
      if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
      
      input.focus();
      input.value = MSG;
      input.dispatchEvent(new InputEvent('input', { bubbles: true, inputType: 'insertText', data: MSG }));
      input.dispatchEvent(new Event('input', { bubbles: true }));
      
      var doSend = function() {
        input.focus();
        input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        input.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
      };
      console.log('=== å·²å‘é€æ€»ç»“æŒ‡ä»¤ï¼Œç­‰å¾… AI å®Œæˆ ===');
      alert('ç‚¹å‡»ç¡®å®šåå°†æ€»ç»“å½“å‰å¯¹è¯å¹¶è‡ªåŠ¨å¯¼å‡ºã€‚');
      setTimeout(doSend, 50);
      
      var stopButtonSeen = false;
      var startTime = Date.now();
      
      var getVisibleLoadingBtn = function() {
        var el = document.querySelector('.submit-button.loading');
        if (el && el.getBoundingClientRect().width > 0 && el.getBoundingClientRect().height > 0) return el;
        return null;
      };
      
      var check = function() {
        var elapsed = Date.now() - startTime;
        var loadingBtn = getVisibleLoadingBtn();
        
        if (loadingBtn) stopButtonSeen = true;
        if (stopButtonSeen && !loadingBtn) {
          doExport('æŒ‰é’®æ£€æµ‹ï¼ˆloading æ¶ˆå¤±ï¼‰');
          return;
        }
        if (elapsed > MAX_GENERATING_MS) {
          alert('ç­‰å¾…è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º');
          return;
        }
        if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) {
          doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰');
          return;
        }
        setTimeout(check, POLL_MS);
      };
      setTimeout(check, POLL_MS);
    };
    
    document.getElementById('sender').href = 'javascript:(' + script.toString() + ')();';
  </script>
</body>
</html>
