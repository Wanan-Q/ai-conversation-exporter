<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ€»ç»“å¹¶å¯¼å‡ºAIå¯¹è¯ï¼ˆé€šç”¨ç‰ˆ v2ï¼‰</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    h1 { color: #333; }
    .info { background: #e8f0fe; padding: 16px; border-radius: 6px; margin: 16px 0; border-left: 4px solid #4285f4; }
    .bookmark { 
      display: inline-block; padding: 12px 24px; background: #4285f4; color: white; 
      text-decoration: none; border-radius: 6px; margin: 10px 0; cursor: move; font-weight: bold;
    }
    .bookmark:hover { background: #3367d6; }
    .step { background: #f5f5f5; padding: 16px; margin: 16px 0; border-radius: 6px; }
    code { background: #eee; padding: 2px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>ğŸ“ æ€»ç»“å¹¶å¯¼å‡ºAIå¯¹è¯ï¼ˆé€šç”¨ç‰ˆ v2ï¼‰</h1>
  <p>æ”¯æŒ 6 ä¸ªä¸»æµ AI å¹³å°ï¼Œè‡ªåŠ¨è¯†åˆ«å¹¶æ‰§è¡Œï¼šå‘é€æ€»ç»“æŒ‡ä»¤ â†’ ç­‰å¾… AI å®Œæˆ â†’ å¯¼å‡ºä¸º Markdown</p>

  <div class="info">
    <strong>âœ¨ é€‚ç”¨åŸŸå</strong>
    <ul style="margin:8px 0;">
      <li>è±†åŒ… - doubao.com</li>
      <li>DeepSeek - chat.deepseek.com</li>
      <li>Gemini - gemini.google.com</li>
      <li>ChatGPT - chatgpt.com / chat.openai.com</li>
      <li>å…ƒå® - yuanbao.tencent.com</li>
      <li>åƒé—® - qianwen.com/chat (éå¤¸å…‹) / qianwen.com/quarkchat (å¤¸å…‹)</li>
    </ul>
  </div>

  <div class="step">
    <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>
    <ol>
      <li>å°†ä¸‹æ–¹æŒ‰é’®æ‹–æ‹½åˆ°æµè§ˆå™¨ä¹¦ç­¾æ </li>
      <li>æ‰“å¼€ä»»ä¸€æ”¯æŒå¹³å°çš„å¯¹è¯é¡µé¢</li>
      <li>ç‚¹å‡»ä¹¦ç­¾ï¼Œè‡ªåŠ¨å‘é€æ€»ç»“æŒ‡ä»¤å¹¶ç­‰å¾…å®Œæˆåå¯¼å‡º</li>
    </ol>
  </div>
  
  <a class="bookmark" id="exporter" href="">ğŸ“ æ€»ç»“å¹¶å¯¼å‡ºAIå¯¹è¯</a>
  
  <p style="margin-top:20px;font-size:0.9em;color:#666;">
    ğŸ’¡ æŒ‰ F12 å¯æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
  </p>

  <script>
    var script = function() {
      try {
      var MSG = 'æ€»ç»“å½“å‰å¯¹è¯ï¼Œåœ¨å¯¹è¯æ¡†ç›´æ¥å›å¤ï¼Œä¸éœ€è¦å›¾ç‰‡å’Œæ–‡ä»¶ã€‚';
      var h = location.hostname;
      var p = (location.pathname || '');
      
      var platform = null;
      if (h.indexOf('doubao.com') >= 0) platform = 'doubao';
      else if (h.indexOf('chat.deepseek.com') >= 0) platform = 'deepseek';
      else if (h.indexOf('gemini.google.com') >= 0) platform = 'gemini';
      else if (h.indexOf('chatgpt.com') >= 0 || h.indexOf('chat.openai.com') >= 0) platform = 'chatgpt';
      else if (h.indexOf('yuanbao.tencent.com') >= 0) platform = 'yuanbao';
      else if (h.indexOf('qianwen.com') >= 0) {
        if (p.indexOf('/quarkchat') >= 0) platform = 'qianwen_quark';
        else if (p.indexOf('/chat') >= 0) platform = 'qianwen_general';
      }
      
      if (!platform) {
        alert('å½“å‰é¡µé¢ä¸æ”¯æŒï¼š' + h + '\n\næ”¯æŒçš„å¹³å°ï¼š\n- doubao.com\n- chat.deepseek.com\n- gemini.google.com\n- chatgpt.com / chat.openai.com\n- yuanbao.tencent.com\n- qianwen.com/chat æˆ– qianwen.com/quarkchat');
        return;
      }
      
      console.log('=== Platform:', platform, '===');
      
      if (platform === 'doubao') runDoubao();
      else if (platform === 'deepseek') runDeepSeek();
      else if (platform === 'gemini') runGemini();
      else if (platform === 'chatgpt') runChatGPT();
      else if (platform === 'yuanbao') runYuanbao();
      else if (platform === 'qianwen_quark') runQianwenQuark();
      else if (platform === 'qianwen_general') runQianwenGeneral();
      
      function runDoubao() {
        var STOP_BTN = '[data-testid="chat_input_local_break_button"]';
        var POLL_MS = 500, WAIT_FOR_START_MS = 15000, MAX_GENERATING_MS = 120000;
        var doExport = mkDoExport('Doubao', { container: '[data-testid="message_content"]', userPattern: 'justify-end', method: 'className' }, '[class*="group/title"] .truncate');
        var input = document.querySelector('[data-testid="chat_input_input"]');
        if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
        input.focus();
        var descriptor = Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype, 'value');
        if (descriptor && descriptor.set) descriptor.set.call(input, MSG);
        else input.value = MSG;
        input.dispatchEvent(new InputEvent('input', { bubbles: true, inputType: 'insertText', data: MSG }));
        input.dispatchEvent(new Event('change', { bubbles: true }));
        input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        alert('ç‚¹å‡»ç¡®å®šåå°†æ€»ç»“å½“å‰å¯¹è¯å¹¶è‡ªåŠ¨å¯¼å‡ºã€‚');
        var stopButtonSeen = false, startTime = Date.now();
        var check = function() {
          var elapsed = Date.now() - startTime;
          var stopBtn = document.querySelector(STOP_BTN);
          if (stopBtn) stopButtonSeen = true;
          if (stopButtonSeen && !stopBtn) { doExport('æŒ‰é’®æ£€æµ‹ï¼ˆåœæ­¢æŒ‰é’®æ¶ˆå¤±ï¼‰'); return; }
          if (elapsed > MAX_GENERATING_MS) { alert('ç­‰å¾…è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º'); return; }
          if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) { doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰'); return; }
          setTimeout(check, POLL_MS);
        };
        setTimeout(check, POLL_MS);
      }
      
      function runDeepSeek() {
        var INPUT_SEL = 'textarea[placeholder*="DeepSeek"]';
        var POLL_MS = 500, WAIT_FOR_START_MS = 15000, MAX_GENERATING_MS = 120000, SILENCE_MS = 2000;
        var doExport = mkDoExport('DeepSeek', { container: '[class*="ds-message"]', userPattern: 'd29f3d7d', method: 'className' }, null);
        var input = document.querySelector(INPUT_SEL);
        if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
        input.focus();
        var descriptor = Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype, 'value');
        if (descriptor && descriptor.set && input.tagName === 'TEXTAREA') descriptor.set.call(input, MSG);
        else if (input.tagName === 'TEXTAREA') input.value = MSG;
        else { input.innerText = MSG; input.textContent = MSG; }
        input.dispatchEvent(new InputEvent('input', { bubbles: true, inputType: 'insertText', data: MSG }));
        input.dispatchEvent(new Event('change', { bubbles: true }));
        input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        alert('ç‚¹å‡»ç¡®å®šåå°†æ€»ç»“å½“å‰å¯¹è¯å¹¶è‡ªåŠ¨å¯¼å‡ºã€‚');
        var stopButtonSeen = false, startTime = Date.now();
        var isVisible = function(el) {
          if (!el) return false;
          var r = el.getBoundingClientRect();
          if (r.width < 20 || r.height < 20) return false;
          if (el.offsetParent === null) return false;
          var s = window.getComputedStyle(el);
          return s.display !== 'none' && s.visibility !== 'hidden';
        };
        var getVisibleStopBtn = function() {
          var hoverBg = document.querySelectorAll('.ds-icon-button__hover-bg');
          for (var i = 0; i < hoverBg.length; i++) {
            var p = hoverBg[i].closest ? hoverBg[i].closest('.ds-icon-button') : hoverBg[i].parentElement;
            if (!p) p = hoverBg[i].parentElement;
            if (p && isVisible(p)) {
              var inputRect = input.getBoundingClientRect();
              var r = p.getBoundingClientRect();
              if (r.top >= inputRect.top - 100 && r.bottom <= inputRect.bottom + 100) return p;
            }
          }
          return null;
        };
        var getVisibleDisabledSendBtn = function() {
          var btns = document.querySelectorAll('.ds-icon-button--disabled');
          var inputRect = input.getBoundingClientRect();
          for (var i = 0; i < btns.length; i++) {
            if (!isVisible(btns[i])) continue;
            var r = btns[i].getBoundingClientRect();
            if (r.top >= inputRect.top - 100 && r.bottom <= inputRect.bottom + 100) return btns[i];
          }
          return null;
        };
        var check = function() {
          var elapsed = Date.now() - startTime;
          var stopBtn = getVisibleStopBtn();
          var disabledSendBtn = getVisibleDisabledSendBtn();
          if (stopBtn) stopButtonSeen = true;
          if (stopButtonSeen && disabledSendBtn) { doExport('æŒ‰é’®æ£€æµ‹ï¼ˆå‘é€é”®ç½®ç°ï¼‰'); return; }
          if (elapsed > MAX_GENERATING_MS) { alert('ç­‰å¾…è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º'); return; }
          if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) {
            var lastLen = 0, stableCount = 0;
            var msgs = document.querySelectorAll('[class*="ds-message"]');
            for (var k = msgs.length - 1; k >= 0; k--) {
              if (msgs[k].getBoundingClientRect().right >= 280) { lastLen = (msgs[k].innerText || '').length; break; }
            }
            if (lastLen > 0) {
              var silenceStart = Date.now();
              var silenceCheck = function() {
                var curLen = 0;
                var m2 = document.querySelectorAll('[class*="ds-message"]');
                for (var k2 = m2.length - 1; k2 >= 0; k2--) {
                  if (m2[k2].getBoundingClientRect().right >= 280) { curLen = (m2[k2].innerText || '').length; break; }
                }
                if (curLen === lastLen && curLen > 0) {
                  if (Date.now() - silenceStart >= SILENCE_MS) { doExport('å…œåº•æœºåˆ¶ï¼ˆå†…å®¹ç¨³å®šï¼‰'); return; }
                } else { lastLen = curLen; silenceStart = Date.now(); }
                if (Date.now() - startTime > MAX_GENERATING_MS) { alert('ç­‰å¾…è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º'); return; }
                setTimeout(silenceCheck, 500);
              };
              setTimeout(silenceCheck, 500);
              return;
            }
            doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰');
            return;
          }
          setTimeout(check, POLL_MS);
        };
        setTimeout(check, POLL_MS);
      }
      
      function runGemini() {
        var POLL_MS = 500, WAIT_FOR_START_MS = 30000, MAX_GENERATING_MS = 180000;
        var doExport = mkDoExportGemini();
        var input = document.querySelector('.ql-editor[contenteditable="true"]') || document.querySelector('[aria-label*="Gemini"][contenteditable="true"]') || document.querySelector('[data-placeholder*="Gemini"]');
        if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
        input.focus();
        if (document.execCommand) { document.execCommand('selectAll', false, null); document.execCommand('insertText', false, MSG); }
        else { input.innerText = MSG; input.textContent = MSG; }
        input.dispatchEvent(new InputEvent('input', { bubbles: true, inputType: 'insertText', data: MSG }));
        input.dispatchEvent(new Event('input', { bubbles: true }));
        var doSend = function() {
          input.focus();
          input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
          input.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        };
        alert('ç‚¹å‡»ç¡®å®šåå°†æ€»ç»“å½“å‰å¯¹è¯å¹¶è‡ªåŠ¨å¯¼å‡ºã€‚');
        setTimeout(doSend, 50);
        var getVisibleStopBtn = function() {
          var icon = document.querySelector('mat-icon[data-mat-icon-name="stop"], mat-icon[data-mat-icon-name="stop_circle"]');
          if (icon) {
            var btn = icon.closest('button');
            if (btn && btn.getBoundingClientRect().width > 0) return btn;
          }
          var byLabel = document.querySelector('button[aria-label*="åœæ­¢"], button[aria-label*="Stop"], [aria-label*="åœæ­¢"]');
          if (byLabel) {
            var b = byLabel.tagName === 'BUTTON' ? byLabel : byLabel.closest('button');
            if (b && b.getBoundingClientRect().width > 0) return b;
          }
          return null;
        };
        var stopButtonSeen = false, startTime = Date.now();
        var check = function() {
          var elapsed = Date.now() - startTime;
          var stopBtn = getVisibleStopBtn();
          if (stopBtn) stopButtonSeen = true;
          if (stopButtonSeen && !stopBtn) {
            doExport('æŒ‰é’®æ£€æµ‹ï¼ˆåœæ­¢æŒ‰é’®æ¶ˆå¤±ï¼‰');
            return;
          }
          if (elapsed > MAX_GENERATING_MS) { alert('ç­‰å¾…è¶…æ—¶ï¼ˆ3åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º'); return; }
          if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) { doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰'); return; }
          setTimeout(check, POLL_MS);
        };
        setTimeout(check, POLL_MS);
      }
      
      function runChatGPT() {
        var STOP_BTN = '[data-testid="stop-button"]';
        var POLL_MS = 500, WAIT_FOR_START_MS = 15000, MAX_GENERATING_MS = 120000;
        var doExport = mkDoExport('ChatGPT', { container: '[data-message-author-role]', method: 'attribute' }, null);
        var input = document.querySelector('#prompt-textarea') || document.querySelector('div.ProseMirror[contenteditable="true"]');
        if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
        input.focus();
        if (document.execCommand) { document.execCommand('selectAll', false, null); document.execCommand('insertText', false, MSG); }
        else { input.innerText = MSG; input.textContent = MSG; }
        input.dispatchEvent(new InputEvent('input', { bubbles: true, inputType: 'insertText', data: MSG }));
        input.dispatchEvent(new Event('input', { bubbles: true }));
        var doSend = function() {
          input.focus();
          input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
          input.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        };
        alert('ç‚¹å‡»ç¡®å®šåå°†æ€»ç»“å½“å‰å¯¹è¯å¹¶è‡ªåŠ¨å¯¼å‡ºã€‚');
        setTimeout(doSend, 50);
        var stopButtonSeen = false, startTime = Date.now();
        var check = function() {
          var elapsed = Date.now() - startTime;
          var stopBtn = document.querySelector(STOP_BTN);
          if (stopBtn) stopButtonSeen = true;
          if (stopButtonSeen && !stopBtn) { doExport('æŒ‰é’®æ£€æµ‹ï¼ˆåœæ­¢æŒ‰é’®æ¶ˆå¤±ï¼‰'); return; }
          if (elapsed > MAX_GENERATING_MS) { alert('ç­‰å¾…è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º'); return; }
          if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) { doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰'); return; }
          setTimeout(check, POLL_MS);
        };
        setTimeout(check, POLL_MS);
      }
      
      function runYuanbao() {
        var STOP_SELS = ['a[class*="style__send-btn"]:not([class*="disabled"])', 'a[class*="stop"]', '[class*="break"]'];
        var DISABLED_SEND = '#yuanbao-send-btn[class*="disabled"]';
        var POLL_MS = 500, WAIT_FOR_START_MS = 15000, MAX_GENERATING_MS = 120000;
        var doExport = mkDoExport('Yuanbao', { container: '[class*="agent-chat__list__item--"]', userPattern: '--human', method: 'className' }, null);
        var input = document.querySelector('#search-bar .ql-editor') || document.querySelector('[class*="chat-input-editor"] .ql-editor') || document.querySelector('.ql-editor[contenteditable="true"][data-placeholder*="å°½ç®¡é—®"]') || document.querySelector('.ql-editor[contenteditable="true"]');
        if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
        input.focus();
        if (document.execCommand) { document.execCommand('selectAll', false, null); document.execCommand('insertText', false, MSG); }
        else { input.innerText = MSG; input.textContent = MSG; }
        input.dispatchEvent(new InputEvent('input', { bubbles: true, inputType: 'insertText', data: MSG }));
        input.dispatchEvent(new Event('input', { bubbles: true }));
        var doSend = function() {
          input.focus();
          input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
          input.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        };
        alert('ç‚¹å‡»ç¡®å®šåå°†æ€»ç»“å½“å‰å¯¹è¯å¹¶è‡ªåŠ¨å¯¼å‡ºã€‚');
        setTimeout(doSend, 50);
        var stopButtonSeen = false, startTime = Date.now();
        var isVisible = function(el) {
          if (!el) return false;
          var r = el.getBoundingClientRect();
          return r.width > 10 && r.height > 10 && el.offsetParent !== null;
        };
        var getVisibleStopBtn = function() {
          for (var i = 0; i < STOP_SELS.length; i++) {
            try {
              var els = document.querySelectorAll(STOP_SELS[i]);
              for (var j = 0; j < els.length; j++) {
                if (els[j].id === 'yuanbao-send-btn') continue;
                if (isVisible(els[j])) {
                  var r = els[j].getBoundingClientRect();
                  var inputRect = input.getBoundingClientRect();
                  if (r.top >= inputRect.top - 150 && r.bottom <= inputRect.bottom + 150) return els[j];
                }
              }
            } catch (e) {}
          }
          return null;
        };
        var getVisibleDisabledSendBtn = function() {
          var btn = document.querySelector(DISABLED_SEND);
          if (btn && isVisible(btn)) return btn;
          btn = document.querySelector('#yuanbao-send-btn');
          if (btn && /disabled/.test(btn.className || '') && isVisible(btn)) return btn;
          return null;
        };
        var check = function() {
          var elapsed = Date.now() - startTime;
          var stopBtn = getVisibleStopBtn();
          var disabledSendBtn = getVisibleDisabledSendBtn();
          if (stopBtn) stopButtonSeen = true;
          if (stopButtonSeen && disabledSendBtn) { doExport('æŒ‰é’®æ£€æµ‹ï¼ˆå‘é€é”®ç½®ç°ï¼‰'); return; }
          if (elapsed > MAX_GENERATING_MS) { alert('ç­‰å¾…è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º'); return; }
          if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) { doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰'); return; }
          setTimeout(check, POLL_MS);
        };
        setTimeout(check, POLL_MS);
      }
      
      function runQianwenQuark() {
        var QW_MSG = 'æ€»ç»“å½“å‰å¯¹è¯ï¼Œå¯¹è¯æ¡†ç›´æ¥å›ç­”ã€‚';
        var POLL_MS = 500, WAIT_FOR_START_MS = 15000, MAX_GENERATING_MS = 120000;
        var doExport = mkDoExportQianwenQuark();
        var input = document.querySelector('textarea[placeholder*="åƒé—®"]') || document.querySelector('textarea[placeholder*="æé—®"]');
        if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
        input.focus();
        input.value = QW_MSG;
        input.dispatchEvent(new InputEvent('input', { bubbles: true, inputType: 'insertText', data: QW_MSG }));
        input.dispatchEvent(new Event('input', { bubbles: true }));
        var doSend = function() {
          input.focus();
          input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
          input.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        };
        alert('ç‚¹å‡»ç¡®å®šåå°†æ€»ç»“å½“å‰å¯¹è¯å¹¶è‡ªåŠ¨å¯¼å‡ºã€‚');
        setTimeout(doSend, 50);
        var stopButtonSeen = false, startTime = Date.now();
        var getVisibleLoadingBtn = function() {
          var el = document.querySelector('.submit-button.loading');
          if (el && el.getBoundingClientRect().width > 0 && el.getBoundingClientRect().height > 0) return el;
          return null;
        };
        var check = function() {
          var elapsed = Date.now() - startTime;
          var loadingBtn = getVisibleLoadingBtn();
          if (loadingBtn) stopButtonSeen = true;
          if (stopButtonSeen && !loadingBtn) { doExport('æŒ‰é’®æ£€æµ‹ï¼ˆloading æ¶ˆå¤±ï¼‰'); return; }
          if (elapsed > MAX_GENERATING_MS) { alert('ç­‰å¾…è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º'); return; }
          if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) { doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰'); return; }
          setTimeout(check, POLL_MS);
        };
        setTimeout(check, POLL_MS);
      }
      
      function runQianwenGeneral() {
        var POLL_MS = 500, WAIT_FOR_START_MS = 15000, MAX_GENERATING_MS = 120000;
        var doExport = mkDoExportQianwenGeneral();
        var tryFillInput = function(input) {
          input.focus();
          try {
            var el = input;
            while (el && el !== document.body) {
              for (var k in el) {
                if (k.indexOf('__reactProps') === 0 || k.indexOf('__reactFiber') === 0) {
                  var fiber = el[k];
                  if (fiber && fiber.children && fiber.children[1]) {
                    var props = fiber.children[1].props || fiber.children[1].memoizedProps;
                    if (props && props.editor) {
                      props.editor.insertText(MSG);
                      if (typeof props.editor.onChange === 'function') props.editor.onChange();
                      return true;
                    }
                  }
                  if (fiber && fiber.return) {
                    var p = fiber.return;
                    for (var i = 0; i < 20 && p; i++) {
                      var mp = p.memoizedProps || p.props;
                      if (mp && mp.editor) {
                        try {
                          if (typeof mp.editor.insertText === 'function') mp.editor.insertText(MSG);
                          if (typeof mp.editor.onChange === 'function') mp.editor.onChange();
                          return true;
                        } catch (e) {}
                      }
                      p = p.return;
                    }
                  }
                }
              }
              el = el.parentElement;
            }
          } catch (e) {}
          return false;
        };
        var getInputText = function(input) {
          return (input.innerText || input.textContent || '').trim();
        };
        var doSend = function(input) {
          var sendBtn = document.querySelector('[class*="operateBtn"]:not([class*="disabled"]) [data-icon-type="qwpcicon-sendChat"]');
          if (sendBtn) {
            var btn = sendBtn.closest('[class*="operateBtn"]');
            if (btn && !/disabled/.test(btn.className || '')) { btn.click(); return; }
          }
          input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
          input.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        };
        var input = document.querySelector('div[data-slate-editor="true"][data-slate-node="value"]') || document.querySelector('div[data-placeholder="å‘åƒé—®æé—®"]') || document.querySelector('[class*="slateEditorWrapper"] [contenteditable="true"]');
        if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
        var filled = tryFillInput(input);
        var hasText = getInputText(input).indexOf('æ€»ç»“') >= 0;
        if (!filled && !hasText) {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(MSG).then(function() {
              alert('è‡ªåŠ¨å¡«å…¥å¤±è´¥ï¼Œå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚\n\nè¯·æ‰‹åŠ¨ç²˜è´´åˆ°è¾“å…¥æ¡†ï¼ˆCtrl+Vï¼‰å¹¶å‘é€ã€‚');
            }).catch(function() { alert('è‡ªåŠ¨å¡«å…¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥å¹¶å‘é€'); });
          } else {
            var ta = document.createElement('textarea');
            ta.value = MSG;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            alert('è‡ªåŠ¨å¡«å…¥å¤±è´¥ï¼Œå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚\n\nè¯·æ‰‹åŠ¨ç²˜è´´åˆ°è¾“å…¥æ¡†ï¼ˆCtrl+Vï¼‰å¹¶å‘é€ã€‚');
          }
        } else {
          alert('å·²å¡«å…¥æ€»ç»“æŒ‡ä»¤ï¼Œç‚¹å‡»ç¡®å®šåè‡ªåŠ¨å‘é€ã€‚');
        }
        setTimeout(function() {
          if (getInputText(input).indexOf('æ€»ç»“') >= 0) {
            doSend(input);
            console.log('=== å·²å‘é€æ€»ç»“æŒ‡ä»¤ï¼Œç­‰å¾… AI å®Œæˆ ===');
          }
        }, 80);
        var stopButtonSeen = false, startTime = Date.now();
        var getVisibleStopBtn = function() {
          var imgs = document.querySelectorAll('img[src*="O1CN01GxD8Fq1ELwB7ZTHVq"]');
          for (var i = 0; i < imgs.length; i++) {
            if (imgs[i].getBoundingClientRect().width > 0 && imgs[i].getBoundingClientRect().height > 0) return imgs[i];
          }
          return null;
        };
        var getVisibleDisabledSendBtn = function() {
          var divs = document.querySelectorAll('[class*="operateBtn"][class*="disabled"]');
          for (var i = 0; i < divs.length; i++) {
            if (divs[i].querySelector('[data-icon-type="qwpcicon-sendChat"]') && divs[i].getBoundingClientRect().width > 0) return divs[i];
          }
          return null;
        };
        var check = function() {
          var elapsed = Date.now() - startTime;
          var stopBtn = getVisibleStopBtn();
          var disabledSendBtn = getVisibleDisabledSendBtn();
          if (stopBtn) stopButtonSeen = true;
          if (stopButtonSeen && disabledSendBtn) { doExport('æŒ‰é’®æ£€æµ‹ï¼ˆå‘é€é”®ç½®ç°ï¼‰'); return; }
          if (elapsed > MAX_GENERATING_MS) { alert('ç­‰å¾…è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º'); return; }
          if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) { doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰'); return; }
          setTimeout(check, POLL_MS);
        };
        setTimeout(check, POLL_MS);
      }
      
      function mkDoExport(name, rule, titleSel) {
        return function(trigger) {
          try {
            var getTitle = function() {
              if (!titleSel) return null;
              try {
                var el = document.querySelector(titleSel);
                if (el && el.innerText) { var t = el.innerText.trim(); if (t.length > 0 && t.length < 100) return t; }
              } catch(e) {}
              return null;
            };
            var exT = function(tb) {
              var rs = tb.querySelectorAll('tr'), md = [];
              for (var r = 0; r < rs.length; r++) {
                var cs = rs[r].querySelectorAll('th, td'), ln = [];
                for (var c = 0; c < cs.length; c++) ln.push((cs[c].innerText || '').trim().replace(/\n+/g, ' ').replace(/\|/g, '\\|'));
                if (ln.length > 0) { md.push('| ' + ln.join(' | ') + ' |'); if (r === 0) md.push('| ' + ln.map(function() { return '---'; }).join(' | ') + ' |'); }
              }
              return md.join('\n');
            };
            var exC = function(p) {
              var c = p.querySelector('code') || p;
              return (c.innerText || '').trim().split('\n').map(function(l) { return l.replace(/^\s*\d+\s+/, ''); }).join('\n');
            };
            var toMd = function(el) {
              var w = function(n) {
                if (!n) return '';
                if (n.nodeType === 3) return n.textContent.replace(/\s+/g, ' ');
                if (n.nodeName === 'TABLE') { var t = exT(n); return t ? '\n\n' + t + '\n\n' : ''; }
                if (n.nodeName === 'PRE') {
                  var cd = exC(n); if (!cd) return '';
                  var ce = n.querySelector('code'), lg = '';
                  if (ce && ce.className) { var m = ce.className.match(/language-(\w+)/); if (m) lg = m[1]; }
                  if (!lg && /(SELECT|def |import )/.test(cd)) lg = /SELECT/.test(cd) ? 'sql' : 'python';
                  return '\n\n```' + lg + '\n' + cd + '\n```\n\n';
                }
                if (/^H[1-6]$/.test(n.nodeName)) { var lv = parseInt(n.nodeName[1]) + 1, hh = ''; for (var i = 0; i < lv; i++) hh += '#'; return '\n\n' + hh + ' ' + wc(n).trim() + '\n\n'; }
                if (n.nodeName === 'P') return wc(n) + '\n';
                if (n.nodeName === 'BR') return '\n';
                if (n.nodeName === 'LI') return '- ' + wc(n).trim() + '\n';
                if (n.nodeName === 'UL' || n.nodeName === 'OL') return '\n' + wc(n);
                if (n.nodeName === 'STRONG' || n.nodeName === 'B') return '**' + wc(n) + '**';
                if (n.nodeName === 'EM' || n.nodeName === 'I') return '*' + wc(n) + '*';
                if (n.nodeName === 'CODE') return '`' + (n.innerText || '').trim() + '`';
                return wc(n);
              };
              var wc = function(n) { if (!n || !n.childNodes) return ''; var o = ''; for (var i = 0; i < n.childNodes.length; i++) o += w(n.childNodes[i]); return o; };
              return w(el).replace(/\n{3,}/g, '\n\n').trim();
            };
            var getRole = function(el) {
              if (rule.method === 'attribute') {
                var role = el.getAttribute('data-message-author-role');
                if (role === 'user') return 'user';
                if (role === 'assistant') return 'assistant';
                return null;
              }
              return new RegExp(rule.userPattern).test(el.className || '') ? 'user' : 'assistant';
            };
            var cs = [], es = document.querySelectorAll(rule.container);
            for (var i = 0; i < es.length; i++) {
              if (rule.method !== 'attribute' && es[i].getBoundingClientRect().right < 280) continue;
              var ro = getRole(es[i]);
              if (ro) cs.push({ el: es[i], role: ro, top: es[i].getBoundingClientRect().top });
            }
            if (cs.length === 0) { alert('æœªæå–åˆ°å¯¹è¯å†…å®¹'); return; }
            cs.sort(function(a, b) { return a.top - b.top; });
            var ms = [];
            for (var i = 0; i < cs.length; i++) {
              var ct = toMd(cs[i].el);
              if (!ct) ct = (cs[i].el.innerText || '').trim();
              if (ct.length > 5) ms.push({ role: cs[i].role, content: ct });
            }
            var mg = [];
            for (var i = 0; i < ms.length; i++) {
              if (mg.length > 0 && mg[mg.length - 1].role === ms[i].role) mg[mg.length - 1].content += '\n\n' + ms[i].content;
              else mg.push(ms[i]);
            }
            if (mg.length > 0 && mg[0].role !== 'user' && mg[0].content.length < 300) mg[0].role = 'user';
            var summaryContent = '', mainMsgs = mg;
            if (mg.length >= 2) {
              var lastUser = mg[mg.length - 2], lastAi = mg[mg.length - 1], cmd = 'æ€»ç»“å½“å‰å¯¹è¯';
              if (lastUser.role === 'user' && lastAi.role === 'assistant' && (lastUser.content.indexOf(cmd) >= 0 || lastUser.content.trim() === cmd + 'ã€‚')) {
                summaryContent = lastAi.content.replace(/\n{3,}/g, '\n\n').trim();
                mainMsgs = mg.slice(0, -2);
              }
            }
            var now = new Date();
            var ts = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2) + '_' + ('0' + now.getHours()).slice(-2) + ('0' + now.getMinutes()).slice(-2) + ('0' + now.getSeconds()).slice(-2);
            var title = getTitle();
            var fn = title ? (name + '_Summary_' + title.replace(/[\\/:*?"<>|]/g, '_') + '_' + ts + '.md') : (name + '_Summary_' + ts + '.md');
            var md = '# ' + name + ' Chat Export (Summary)\n\n> ' + now.toLocaleString('zh-CN') + '\n\n';
            if (summaryContent) md += '# å¯¹è¯æ€»ç»“\n\n' + summaryContent + '\n\n---\n\n';
            for (var i = 0; i < mainMsgs.length; i++) {
              var tx = mainMsgs[i].content.replace(/\n{3,}/g, '\n\n').trim();
              if (mainMsgs[i].role === 'user') md += '# User\n\n' + tx + '\n\n---\n\n';
              else md += '# AI\n\n' + tx + '\n\n';
            }
            var bl = new Blob([md.trim()], { type: 'text/markdown;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(bl);
            a.download = fn;
            a.click();
            URL.revokeObjectURL(a.href);
            console.log('=== å¯¼å‡ºå®Œæˆ [' + (trigger || 'æœªçŸ¥') + '] ===');
            alert('å·²å¯¼å‡º ' + mainMsgs.length + ' æ¡æ¶ˆæ¯' + (summaryContent ? 'ï¼ˆå«æ€»ç»“ï¼‰' : '') + '\n\nè§¦å‘æ–¹å¼ï¼š' + (trigger || 'æœªçŸ¥') + '\n\n' + fn);
          } catch (e) {
            console.error('Export error:', e);
            alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
          }
        };
      }
      
      function mkDoExportGemini() {
        return function(trigger) {
          try {
            var rule = { name: 'Gemini', userTag: 'USER-QUERY-CONTENT', aiTag: 'MESSAGE-CONTENT', method: 'tagName' };
            var getTitle = function() {
              try {
                var el = document.querySelector('span.gds-title-m, span[class*="conversation-title"]');
                if (el && el.innerText) { var t = el.innerText.trim(); if (t.length > 0 && t.length < 100) return t; }
              } catch(e) {}
              return null;
            };
            var exT = function(tb) {
              var rs = tb.querySelectorAll('tr'), md = [];
              for (var r = 0; r < rs.length; r++) {
                var cs = rs[r].querySelectorAll('th, td'), ln = [];
                for (var c = 0; c < cs.length; c++) ln.push((cs[c].innerText || '').trim().replace(/\n+/g, ' ').replace(/\|/g, '\\|'));
                if (ln.length > 0) { md.push('| ' + ln.join(' | ') + ' |'); if (r === 0) md.push('| ' + ln.map(function() { return '---'; }).join(' | ') + ' |'); }
              }
              return md.join('\n');
            };
            var exC = function(p) {
              var c = p.querySelector('code') || p;
              return (c.innerText || '').trim().split('\n').map(function(l) { return l.replace(/^\s*\d+\s+/, ''); }).join('\n');
            };
            var toMd = function(el) {
              var w = function(n) {
                if (!n) return '';
                if (n.nodeType === 3) return n.textContent.replace(/\s+/g, ' ');
                if (n.nodeName === 'TABLE') { var t = exT(n); return t ? '\n\n' + t + '\n\n' : ''; }
                if (n.nodeName === 'PRE') {
                  var cd = exC(n); if (!cd) return '';
                  var ce = n.querySelector('code'), lg = '';
                  if (ce && ce.className) { var m = ce.className.match(/language-(\w+)/); if (m) lg = m[1]; }
                  if (!lg && /(SELECT|def |import )/.test(cd)) lg = /SELECT/.test(cd) ? 'sql' : 'python';
                  return '\n\n```' + lg + '\n' + cd + '\n```\n\n';
                }
                if (/^H[1-6]$/.test(n.nodeName)) { var lv = parseInt(n.nodeName[1]) + 1, hh = ''; for (var i = 0; i < lv; i++) hh += '#'; return '\n\n' + hh + ' ' + wc(n).trim() + '\n\n'; }
                if (n.nodeName === 'P') return wc(n) + '\n';
                if (n.nodeName === 'BR') return '\n';
                if (n.nodeName === 'LI') return '- ' + wc(n).trim() + '\n';
                if (n.nodeName === 'UL' || n.nodeName === 'OL') return '\n' + wc(n);
                if (n.nodeName === 'STRONG' || n.nodeName === 'B') return '**' + wc(n) + '**';
                if (n.nodeName === 'EM' || n.nodeName === 'I') return '*' + wc(n) + '*';
                if (n.nodeName === 'CODE') return '`' + (n.innerText || '').trim() + '`';
                return wc(n);
              };
              var wc = function(n) { if (!n || !n.childNodes) return ''; var o = ''; for (var i = 0; i < n.childNodes.length; i++) o += w(n.childNodes[i]); return o; };
              return w(el).replace(/\n{3,}/g, '\n\n').trim();
            };
            var cs = [];
            var ue = document.querySelectorAll(rule.userTag.toLowerCase());
            var ae = document.querySelectorAll(rule.aiTag.toLowerCase());
            for (var i = 0; i < ue.length; i++) cs.push({ el: ue[i], role: 'user', top: ue[i].getBoundingClientRect().top });
            for (var i = 0; i < ae.length; i++) {
              var p = ae[i].parentElement;
              if (p && p.nodeName.toLowerCase() === rule.userTag.toLowerCase()) continue;
              cs.push({ el: ae[i], role: 'assistant', top: ae[i].getBoundingClientRect().top });
            }
            if (cs.length === 0) { alert('æœªæå–åˆ°å¯¹è¯å†…å®¹'); return; }
            cs.sort(function(a, b) { return a.top - b.top; });
            var ms = [];
            for (var i = 0; i < cs.length; i++) {
              var ct = toMd(cs[i].el);
              if (!ct) ct = (cs[i].el.innerText || '').trim();
              if (ct.length > 5) ms.push({ role: cs[i].role, content: ct });
            }
            var mg = [];
            for (var i = 0; i < ms.length; i++) {
              if (mg.length > 0 && mg[mg.length - 1].role === ms[i].role) mg[mg.length - 1].content += '\n\n' + ms[i].content;
              else mg.push(ms[i]);
            }
            if (mg.length > 0 && mg[0].role !== 'user' && mg[0].content.length < 300) mg[0].role = 'user';
            var summaryContent = '', mainMsgs = mg;
            if (mg.length >= 2) {
              var lastUser = mg[mg.length - 2], lastAi = mg[mg.length - 1], cmd = 'æ€»ç»“å½“å‰å¯¹è¯';
              if (lastUser.role === 'user' && lastAi.role === 'assistant' && (lastUser.content.indexOf(cmd) >= 0 || lastUser.content.trim() === cmd + 'ã€‚')) {
                summaryContent = lastAi.content.replace(/\n{3,}/g, '\n\n').trim();
                mainMsgs = mg.slice(0, -2);
              }
            }
            var now = new Date();
            var ts = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2) + '_' + ('0' + now.getHours()).slice(-2) + ('0' + now.getMinutes()).slice(-2) + ('0' + now.getSeconds()).slice(-2);
            var title = getTitle();
            var fn = title ? ('Gemini_Summary_' + title.replace(/[\\/:*?"<>|]/g, '_') + '_' + ts + '.md') : ('Gemini_Summary_' + ts + '.md');
            var md = '# Gemini Chat Export (Summary)\n\n> ' + now.toLocaleString('zh-CN') + '\n\n';
            if (summaryContent) md += '# å¯¹è¯æ€»ç»“\n\n' + summaryContent + '\n\n---\n\n';
            for (var i = 0; i < mainMsgs.length; i++) {
              var tx = mainMsgs[i].content.replace(/\n{3,}/g, '\n\n').trim();
              if (mainMsgs[i].role === 'user') md += '# User\n\n' + tx + '\n\n---\n\n';
              else md += '# AI\n\n' + tx + '\n\n';
            }
            var bl = new Blob([md.trim()], { type: 'text/markdown;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(bl);
            a.download = fn;
            a.click();
            URL.revokeObjectURL(a.href);
            console.log('=== å¯¼å‡ºå®Œæˆ [' + (trigger || 'æœªçŸ¥') + '] ===');
            alert('å·²å¯¼å‡º ' + mainMsgs.length + ' æ¡æ¶ˆæ¯' + (summaryContent ? 'ï¼ˆå«æ€»ç»“ï¼‰' : '') + '\n\nè§¦å‘æ–¹å¼ï¼š' + (trigger || 'æœªçŸ¥') + '\n\n' + fn);
          } catch (e) {
            console.error('Export error:', e);
            alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
          }
        };
      }
      
      function mkDoExportQianwenQuark() {
        return function(trigger) {
          try {
            var rules = [
              { container: '[class*="message-select-wrapper"]', userPattern: 'question' },
              { container: '[class*="message-select"]', userPattern: 'question' },
              { container: '[class*="message-wrapper"]', userPattern: 'question' },
              { container: '[class*="chat-message"]', userPattern: 'user|question' },
              { container: '[class*="bubble"]', userPattern: 'user|question|right' },
              { container: 'article', userPattern: 'user|question' }
            ];
            var rule = null;
            var exT = function(tb) {
              var rs = tb.querySelectorAll('tr'), md = [];
              for (var r = 0; r < rs.length; r++) {
                var cs = rs[r].querySelectorAll('th, td'), ln = [];
                for (var c = 0; c < cs.length; c++) ln.push((cs[c].innerText || '').trim().replace(/\n+/g, ' ').replace(/\|/g, '\\|'));
                if (ln.length > 0) { md.push('| ' + ln.join(' | ') + ' |'); if (r === 0) md.push('| ' + ln.map(function() { return '---'; }).join(' | ') + ' |'); }
              }
              return md.join('\n');
            };
            var exC = function(p) {
              var c = p.querySelector('code') || p;
              return (c.innerText || '').trim().split('\n').map(function(l) { return l.replace(/^\s*\d+\s+/, ''); }).join('\n');
            };
            var toMd = function(el) {
              var w = function(n) {
                if (!n) return '';
                if (n.nodeType === 1 && n.getAttribute && n.getAttribute('data-c') === 'result_card') return '';
                if (n.nodeType === 1 && n.className && ('' + n.className).indexOf('recommend-query-wrap') >= 0) return '';
                if (n.nodeType === 3) return n.textContent.replace(/\s+/g, ' ');
                if (n.nodeName === 'TABLE') { var t = exT(n); return t ? '\n\n' + t + '\n\n' : ''; }
                if (n.nodeName === 'PRE') {
                  var cd = exC(n); if (!cd) return '';
                  var ce = n.querySelector('code'), lg = '';
                  if (ce && ce.className) { var m = ce.className.match(/language-(\w+)/); if (m) lg = m[1]; }
                  if (!lg && /(SELECT|def |import )/.test(cd)) lg = /SELECT/.test(cd) ? 'sql' : 'python';
                  return '\n\n```' + lg + '\n' + cd + '\n```\n\n';
                }
                if (/^H[1-6]$/.test(n.nodeName)) { var lv = parseInt(n.nodeName[1]) + 1, hh = ''; for (var i = 0; i < lv; i++) hh += '#'; return '\n\n' + hh + ' ' + wc(n).trim() + '\n\n'; }
                if (n.nodeName === 'P') return wc(n) + '\n';
                if (n.nodeName === 'BR') return '\n';
                if (n.nodeName === 'LI') return '- ' + wc(n).trim() + '\n';
                if (n.nodeName === 'UL' || n.nodeName === 'OL') return '\n' + wc(n);
                if (n.nodeName === 'STRONG' || n.nodeName === 'B') return '**' + wc(n) + '**';
                if (n.nodeName === 'EM' || n.nodeName === 'I') return '*' + wc(n) + '*';
                if (n.nodeName === 'CODE') return '`' + (n.innerText || '').trim() + '`';
                return wc(n);
              };
              var wc = function(n) { if (!n || !n.childNodes) return ''; var o = ''; for (var i = 0; i < n.childNodes.length; i++) o += w(n.childNodes[i]); return o; };
              return w(el).replace(/\n{3,}/g, '\n\n').trim();
            };
            var cs = [];
            for (var r = 0; r < rules.length; r++) {
              rule = rules[r];
              var getRole = function(el, pat) {
                for (var n = el; n && n !== document.body; n = n.parentElement) {
                  if (new RegExp(pat).test(n.className || '')) return 'user';
                }
                return 'assistant';
              };
              var es = document.querySelectorAll(rule.container);
              cs = [];
              for (var i = 0; i < es.length; i++) {
                if (es[i].getBoundingClientRect().right < 280) continue;
                cs.push({ el: es[i], role: getRole(es[i], rule.userPattern), top: es[i].getBoundingClientRect().top });
              }
              if (cs.length > 0) break;
            }
            if (cs.length === 0) { alert('æœªæå–åˆ°å¯¹è¯å†…å®¹'); return; }
            cs.sort(function(a, b) { return a.top - b.top; });
            var ms = [];
            for (var i = 0; i < cs.length; i++) {
              var ct = toMd(cs[i].el);
              if (!ct) ct = (cs[i].el.innerText || '').trim();
              if (ct.length > 5) ms.push({ role: cs[i].role, content: ct });
            }
            var mg = [];
            for (var i = 0; i < ms.length; i++) {
              if (mg.length > 0 && mg[mg.length - 1].role === ms[i].role) mg[mg.length - 1].content += '\n\n' + ms[i].content;
              else mg.push(ms[i]);
            }
            if (mg.length > 0 && mg[0].role !== 'user' && mg[0].content.length < 300) mg[0].role = 'user';
            var summaryContent = '', mainMsgs = mg;
            if (mg.length >= 2) {
              var lastUser = mg[mg.length - 2], lastAi = mg[mg.length - 1], cmd = 'æ€»ç»“å½“å‰å¯¹è¯';
              if (lastUser.role === 'user' && lastAi.role === 'assistant' && (lastUser.content.indexOf(cmd) >= 0 || lastUser.content.trim() === cmd + 'ã€‚')) {
                summaryContent = lastAi.content.replace(/\n{3,}/g, '\n\n').trim();
                mainMsgs = mg.slice(0, -2);
              }
            }
            var now = new Date();
            var ts = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2) + '_' + ('0' + now.getHours()).slice(-2) + ('0' + now.getMinutes()).slice(-2) + ('0' + now.getSeconds()).slice(-2);
            var fn = 'Qianwen_Summary_' + ts + '.md';
            var md = '# Qianwen Chat Export (Summary)\n\n> ' + now.toLocaleString('zh-CN') + '\n\n';
            if (summaryContent) md += '# å¯¹è¯æ€»ç»“\n\n' + summaryContent + '\n\n---\n\n';
            for (var i = 0; i < mainMsgs.length; i++) {
              var tx = mainMsgs[i].content.replace(/\n{3,}/g, '\n\n').trim();
              if (mainMsgs[i].role === 'user') md += '# User\n\n' + tx + '\n\n---\n\n';
              else md += '# AI\n\n' + tx + '\n\n';
            }
            var bl = new Blob([md.trim()], { type: 'text/markdown;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(bl);
            a.download = fn;
            a.click();
            URL.revokeObjectURL(a.href);
            console.log('=== å¯¼å‡ºå®Œæˆ [' + (trigger || 'æœªçŸ¥') + '] ===');
            alert('å·²å¯¼å‡º ' + mainMsgs.length + ' æ¡æ¶ˆæ¯' + (summaryContent ? 'ï¼ˆå«æ€»ç»“ï¼‰' : '') + '\n\nè§¦å‘æ–¹å¼ï¼š' + (trigger || 'æœªçŸ¥') + '\n\n' + fn);
          } catch (e) {
            console.error('Export error:', e);
            alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
          }
        };
      }
      
      function mkDoExportQianwenGeneral() {
        return function(trigger) {
          try {
            var exT = function(tb) {
              var rs = tb.querySelectorAll('tr'), md = [];
              for (var r = 0; r < rs.length; r++) {
                var cs = rs[r].querySelectorAll('th, td'), ln = [];
                for (var c = 0; c < cs.length; c++) ln.push((cs[c].innerText || '').trim().replace(/\n+/g, ' ').replace(/\|/g, '\\|'));
                if (ln.length > 0) { md.push('| ' + ln.join(' | ') + ' |'); if (r === 0) md.push('| ' + ln.map(function() { return '---'; }).join(' | ') + ' |'); }
              }
              return md.join('\n');
            };
            var exC = function(p, lang) {
              var c = p.querySelector('code') || p;
              var raw = (c.innerText || c.textContent || '').trim();
              var lines = raw.split('\n').map(function(l) { return l.replace(/^\s*\d+\s*/, ''); });
              return lines.join('\n');
            };
            var getCodeLang = function(pre) {
              var wrap = pre.closest ? pre.closest('[class*="rounded"]') : null;
              if (!wrap) return '';
              var sp = wrap.querySelector('span[class*="font-medium"]');
              if (sp) { var t = (sp.innerText || '').trim(); if (t && t.length < 20) return t; }
              return '';
            };
            var toMd = function(el) {
              var w = function(n) {
                if (!n) return '';
                if (n.nodeType === 3) return n.textContent.replace(/\s+/g, ' ');
                if (n.nodeName === 'TABLE') { var t = exT(n); return t ? '\n\n' + t + '\n\n' : ''; }
                if (n.nodeName === 'PRE') {
                  var cd = exC(n); if (!cd) return '';
                  var lg = getCodeLang(n) || '';
                  if (!lg && n.querySelector('code')) { var ce = n.querySelector('code'); var m = (ce.className || '').match(/language-(\w+)/); if (m) lg = m[1]; }
                  if (!lg && /(SELECT|def |import )/.test(cd)) lg = /SELECT/.test(cd) ? 'sql' : 'python';
                  return '\n\n```' + lg + '\n' + cd + '\n```\n\n';
                }
                var cls = (n.className || '').toString();
                if (/qk-md-table-section/.test(cls)) {
                  var tbl = n.querySelector('table');
                  return tbl ? '\n\n' + exT(tbl) + '\n\n' : wc(n);
                }
                if (/qk-md-head/.test(cls) && /^H[1-6]$/.test(n.nodeName)) {
                  var lv = parseInt(n.nodeName[1]) + 1, hh = ''; for (var i = 0; i < lv; i++) hh += '#'; return '\n\n' + hh + ' ' + wc(n).trim() + '\n\n';
                }
                if (/qk-md-paragraph/.test(cls)) return wc(n) + '\n';
                if (/^H[1-6]$/.test(n.nodeName)) { var lv = parseInt(n.nodeName[1]) + 1, hh = ''; for (var i = 0; i < lv; i++) hh += '#'; return '\n\n' + hh + ' ' + wc(n).trim() + '\n\n'; }
                if (n.nodeName === 'P') return wc(n) + '\n';
                if (n.nodeName === 'BR') return '\n';
                if (n.nodeName === 'LI' || /qk-md-li/.test(cls)) return '- ' + wc(n).trim() + '\n';
                if (n.nodeName === 'UL' || n.nodeName === 'OL' || /qk-md-ul/.test(cls)) return '\n' + wc(n);
                if (n.nodeName === 'STRONG' || n.nodeName === 'B' || /qk-md-strong/.test(cls)) return '**' + wc(n) + '**';
                if (n.nodeName === 'EM' || n.nodeName === 'I') return '*' + wc(n) + '*';
                if (n.nodeName === 'CODE') return '`' + (n.innerText || '').trim() + '`';
                return wc(n);
              };
              var wc = function(n) { if (!n || !n.childNodes) return ''; var o = ''; for (var i = 0; i < n.childNodes.length; i++) o += w(n.childNodes[i]); return o; };
              return w(el).replace(/\n{3,}/g, '\n\n').trim();
            };
            var cs = [];
            var userEls = document.querySelectorAll('[class*="contentBox"]');
            var aiEls = document.querySelectorAll('[class*="qk-markdown"]');
            for (var i = 0; i < userEls.length; i++) {
              var r = userEls[i].getBoundingClientRect();
              if (r.right < 200) continue;
              cs.push({ el: userEls[i], role: 'user', top: r.top });
            }
            for (var j = 0; j < aiEls.length; j++) {
              var r2 = aiEls[j].getBoundingClientRect();
              if (r2.right < 200) continue;
              cs.push({ el: aiEls[j], role: 'assistant', top: r2.top });
            }
            if (cs.length === 0) { alert('æœªæå–åˆ°å¯¹è¯å†…å®¹'); return; }
            cs.sort(function(a, b) { return a.top - b.top; });
            var ms = [];
            for (var k = 0; k < cs.length; k++) {
              var ct = toMd(cs[k].el);
              if (!ct) ct = (cs[k].el.innerText || '').trim();
              if (ct.length > 2) ms.push({ role: cs[k].role, content: ct });
            }
            var mg = [];
            for (var m = 0; m < ms.length; m++) {
              if (mg.length > 0 && mg[mg.length - 1].role === ms[m].role) mg[mg.length - 1].content += '\n\n' + ms[m].content;
              else mg.push(ms[m]);
            }
            if (mg.length > 0 && mg[0].role !== 'user' && mg[0].content.length < 300) mg[0].role = 'user';
            var summaryContent = '', mainMsgs = mg;
            if (mg.length >= 2) {
              var lastUser = mg[mg.length - 2], lastAi = mg[mg.length - 1], cmd = 'æ€»ç»“å½“å‰å¯¹è¯';
              if (lastUser.role === 'user' && lastAi.role === 'assistant' && lastUser.content.indexOf(cmd) >= 0) {
                summaryContent = lastAi.content.replace(/\n{3,}/g, '\n\n').trim();
                mainMsgs = mg.slice(0, -2);
              }
            }
            var now = new Date();
            var ts = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2) + '_' + ('0' + now.getHours()).slice(-2) + ('0' + now.getMinutes()).slice(-2) + ('0' + now.getSeconds()).slice(-2);
            var fn = 'Qianwen_Summary_' + ts + '.md';
            var md = '# Qianwen Chat Export (Summary)\n\n> ' + now.toLocaleString('zh-CN') + '\n\n';
            if (summaryContent) md += '# å¯¹è¯æ€»ç»“\n\n' + summaryContent + '\n\n---\n\n';
            md += '---\n\n';
            for (var x = 0; x < mainMsgs.length; x++) {
              var tx = mainMsgs[x].content.replace(/\n{3,}/g, '\n\n').trim();
              if (mainMsgs[x].role === 'user') md += '# User\n\n' + tx + '\n\n---\n\n';
              else md += '# AI\n\n' + tx + '\n\n';
            }
            var bl = new Blob([md.trim()], { type: 'text/markdown;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(bl);
            a.download = fn;
            a.click();
            URL.revokeObjectURL(a.href);
            console.log('=== å¯¼å‡ºå®Œæˆ [' + (trigger || 'æœªçŸ¥') + '] ===');
            alert('å·²å¯¼å‡º ' + mainMsgs.length + ' æ¡æ¶ˆæ¯' + (summaryContent ? 'ï¼ˆå«æ€»ç»“ï¼‰' : '') + '\n\n' + fn);
          } catch (e) {
            console.error('Export error:', e);
            alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
          }
        };
      }
      } catch (e) {
        console.error('Error:', e);
        alert('Export failed: ' + (e && e.message ? e.message : String(e)));
      }
    };
    
    document.getElementById('exporter').href = 'javascript:(' + script.toString() + ')();';
  </script>
</body>
</html>
