<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gemini - æ€»ç»“å¹¶å¯¼å‡º</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    h1 { color: #333; }
    .info { background: #e8f0fe; padding: 16px; border-radius: 6px; margin: 16px 0; border-left: 4px solid #4285f4; }
    .bookmark { 
      display: inline-block; padding: 12px 24px; background: #4285f4; color: white; 
      text-decoration: none; border-radius: 6px; margin: 10px 0; cursor: move; font-weight: bold;
    }
    .bookmark:hover { background: #3367d6; }
    .step { background: #f5f5f5; padding: 16px; margin: 16px 0; border-radius: 6px; }
    code { background: #eee; padding: 2px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>ğŸ“ æ€»ç»“å¹¶å¯¼å‡ºï¼ˆGeminiï¼‰</h1>
  <p>å‘é€ã€Œæ€»ç»“å½“å‰å¯¹è¯ï¼Œåœ¨å¯¹è¯æ¡†ç›´æ¥å›å¤ï¼Œä¸éœ€è¦å›¾ç‰‡å’Œæ–‡ä»¶ã€‚ã€â†’ ç­‰å¾… AI ç”Ÿæˆå®Œæˆ â†’ è‡ªåŠ¨å¯¼å‡ºä¸º Markdown</p>

  <div class="info">
    <strong>âœ¨ é€‚ç”¨åŸŸå</strong>
    <ul style="margin:8px 0;">
      <li>Gemini - gemini.google.com</li>
    </ul>
  </div>

  <div class="step">
    <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>
    <ol>
      <li>å°†ä¸‹æ–¹æŒ‰é’®æ‹–æ‹½åˆ°æµè§ˆå™¨ä¹¦ç­¾æ </li>
      <li>æ‰“å¼€ Gemini å¯¹è¯é¡µé¢ (gemini.google.com)</li>
      <li>ç‚¹å‡»ä¹¦ç­¾ï¼Œè‡ªåŠ¨å‘é€æ€»ç»“æŒ‡ä»¤å¹¶ç­‰å¾…å®Œæˆåå¯¼å‡º</li>
    </ol>
  </div>
  
  <a class="bookmark" id="sender" href="">ğŸ“ æ€»ç»“å¹¶å¯¼å‡ºGeminiå¯¹è¯</a>
  
  <p style="margin-top:20px;font-size:0.9em;color:#666;">
    ğŸ’¡ é€šè¿‡ data-test-lottie-animation-status="completed" åˆ¤æ–­ AI æ˜¯å¦å®Œæˆã€‚æŒ‰ F12 å¯æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚
  </p>

  <script>
    var script = function() {
      var MSG = 'æ€»ç»“å½“å‰å¯¹è¯ï¼Œåœ¨å¯¹è¯æ¡†ç›´æ¥å›å¤ï¼Œä¸éœ€è¦å›¾ç‰‡å’Œæ–‡ä»¶ã€‚';
      var POLL_MS = 500;
      var WAIT_FOR_START_MS = 30000;
      var MAX_GENERATING_MS = 180000;
      
      if (location.hostname.indexOf('gemini.google.com') < 0) {
        alert('è¯·åœ¨ Gemini (gemini.google.com) å¯¹è¯é¡µé¢ä½¿ç”¨æ­¤ä¹¦ç­¾');
        return;
      }
      
      var doExport = function(trigger) {
        try {
          var rule = { name: 'Gemini', userTag: 'USER-QUERY-CONTENT', aiTag: 'MESSAGE-CONTENT', method: 'tagName' };
          var getTitle = function() {
            try {
              var el = document.querySelector('span.gds-title-m, span[class*="conversation-title"]');
              if (el && el.innerText) { var t = el.innerText.trim(); if (t.length > 0 && t.length < 100) return t; }
            } catch(e) {}
            return null;
          };
          var exT = function(tb) {
            var rs = tb.querySelectorAll('tr'), md = [];
            for (var r = 0; r < rs.length; r++) {
              var cs = rs[r].querySelectorAll('th, td'), ln = [];
              for (var c = 0; c < cs.length; c++) ln.push((cs[c].innerText || '').trim().replace(/\n+/g, ' ').replace(/\|/g, '\\|'));
              if (ln.length > 0) { md.push('| ' + ln.join(' | ') + ' |'); if (r === 0) md.push('| ' + ln.map(function() { return '---'; }).join(' | ') + ' |'); }
            }
            return md.join('\n');
          };
          var exC = function(p) {
            var c = p.querySelector('code') || p;
            return (c.innerText || '').trim().split('\n').map(function(l) { return l.replace(/^\s*\d+\s+/, ''); }).join('\n');
          };
          var toMd = function(el) {
            var w = function(n) {
              if (!n) return '';
              if (n.nodeType === 3) return n.textContent.replace(/\s+/g, ' ');
              if (n.nodeName === 'TABLE') { var t = exT(n); return t ? '\n\n' + t + '\n\n' : ''; }
              if (n.nodeName === 'PRE') {
                var cd = exC(n); if (!cd) return '';
                var ce = n.querySelector('code'), lg = '';
                if (ce && ce.className) { var m = ce.className.match(/language-(\w+)/); if (m) lg = m[1]; }
                if (!lg && /(SELECT|def |import )/.test(cd)) lg = /SELECT/.test(cd) ? 'sql' : 'python';
                return '\n\n```' + lg + '\n' + cd + '\n```\n\n';
              }
              if (/^H[1-6]$/.test(n.nodeName)) { var lv = parseInt(n.nodeName[1]) + 1, hh = ''; for (var i = 0; i < lv; i++) hh += '#'; return '\n\n' + hh + ' ' + wc(n).trim() + '\n\n'; }
              if (n.nodeName === 'P') return wc(n) + '\n';
              if (n.nodeName === 'BR') return '\n';
              if (n.nodeName === 'LI') return '- ' + wc(n).trim() + '\n';
              if (n.nodeName === 'UL' || n.nodeName === 'OL') return '\n' + wc(n);
              if (n.nodeName === 'STRONG' || n.nodeName === 'B') return '**' + wc(n) + '**';
              if (n.nodeName === 'EM' || n.nodeName === 'I') return '*' + wc(n) + '*';
              if (n.nodeName === 'CODE') return '`' + (n.innerText || '').trim() + '`';
              return wc(n);
            };
            var wc = function(n) { if (!n || !n.childNodes) return ''; var o = ''; for (var i = 0; i < n.childNodes.length; i++) o += w(n.childNodes[i]); return o; };
            return w(el).replace(/\n{3,}/g, '\n\n').trim();
          };
          var getRole = function(el) {
            var t = el.nodeName.toUpperCase();
            if (t === rule.userTag) return 'user';
            if (t === rule.aiTag) return 'assistant';
            return null;
          };
          var cs = [];
          var ue = document.querySelectorAll(rule.userTag.toLowerCase());
          var ae = document.querySelectorAll(rule.aiTag.toLowerCase());
          for (var i = 0; i < ue.length; i++) cs.push({ el: ue[i], role: 'user', top: ue[i].getBoundingClientRect().top });
          for (var i = 0; i < ae.length; i++) {
            var p = ae[i].parentElement;
            if (p && p.nodeName.toLowerCase() === rule.userTag.toLowerCase()) continue;
            cs.push({ el: ae[i], role: 'assistant', top: ae[i].getBoundingClientRect().top });
          }
          if (cs.length === 0) { alert('æœªæå–åˆ°å¯¹è¯å†…å®¹'); return; }
          cs.sort(function(a, b) { return a.top - b.top; });
          var ms = [];
          for (var i = 0; i < cs.length; i++) {
            var ct = toMd(cs[i].el);
            if (!ct) ct = (cs[i].el.innerText || '').trim();
            if (ct.length > 5) ms.push({ role: cs[i].role, content: ct });
          }
          var mg = [];
          for (var i = 0; i < ms.length; i++) {
            if (mg.length > 0 && mg[mg.length - 1].role === ms[i].role) mg[mg.length - 1].content += '\n\n' + ms[i].content;
            else mg.push(ms[i]);
          }
          if (mg.length > 0 && mg[0].role !== 'user' && mg[0].content.length < 300) mg[0].role = 'user';
          var summaryContent = '';
          var mainMsgs = mg;
          if (mg.length >= 2) {
            var lastUser = mg[mg.length - 2];
            var lastAi = mg[mg.length - 1];
            var cmd = 'æ€»ç»“å½“å‰å¯¹è¯';
            if (lastUser.role === 'user' && lastAi.role === 'assistant' && (lastUser.content.indexOf(cmd) >= 0 || lastUser.content.trim() === cmd + 'ã€‚')) {
              summaryContent = lastAi.content.replace(/\n{3,}/g, '\n\n').trim();
              mainMsgs = mg.slice(0, -2);
            }
          }
          var now = new Date();
          var ts = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2) + '_' + ('0' + now.getHours()).slice(-2) + ('0' + now.getMinutes()).slice(-2) + ('0' + now.getSeconds()).slice(-2);
          var title = getTitle();
          var fn = title ? ('Gemini_Summary_' + title.replace(/[\\/:*?"<>|]/g, '_') + '_' + ts + '.md') : ('Gemini_Summary_' + ts + '.md');
          var md = '# Gemini Chat Export (Summary)\n\n> ' + now.toLocaleString('zh-CN') + '\n\n';
          if (summaryContent) {
            md += '# å¯¹è¯æ€»ç»“\n\n' + summaryContent + '\n\n---\n\n';
          }
          for (var i = 0; i < mainMsgs.length; i++) {
            var tx = mainMsgs[i].content.replace(/\n{3,}/g, '\n\n').trim();
            if (mainMsgs[i].role === 'user') md += '# User\n\n' + tx + '\n\n---\n\n';
            else md += '# AI\n\n' + tx + '\n\n';
          }
          var bl = new Blob([md.trim()], { type: 'text/markdown;charset=utf-8' });
          var a = document.createElement('a');
          a.href = URL.createObjectURL(bl);
          a.download = fn;
          a.click();
          URL.revokeObjectURL(a.href);
          var triggerText = trigger || 'æœªçŸ¥';
          console.log('=== å¯¼å‡ºå®Œæˆ [' + triggerText + '] ===');
          alert('å·²å¯¼å‡º ' + mainMsgs.length + ' æ¡æ¶ˆæ¯' + (summaryContent ? 'ï¼ˆå«æ€»ç»“ï¼‰' : '') + '\n\nè§¦å‘æ–¹å¼ï¼š' + triggerText + '\n\n' + fn);
        } catch (e) {
          console.error('Export error:', e);
          alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
        }
      };
      
      var input = document.querySelector('.ql-editor[contenteditable="true"]') || document.querySelector('[aria-label*="Gemini"][contenteditable="true"]') || document.querySelector('[data-placeholder*="Gemini"]');
      if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
      
      input.focus();
      if (document.execCommand) {
        document.execCommand('selectAll', false, null);
        document.execCommand('insertText', false, MSG);
      } else {
        input.innerText = MSG;
        input.textContent = MSG;
      }
      input.dispatchEvent(new InputEvent('input', { bubbles: true, inputType: 'insertText', data: MSG }));
      input.dispatchEvent(new Event('input', { bubbles: true }));
      
      var doSend = function() {
        input.focus();
        input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        input.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
      };
      console.log('=== å·²å‘é€æ€»ç»“æŒ‡ä»¤ï¼Œç­‰å¾… AI å®Œæˆ ===');
      alert('ç‚¹å‡»ç¡®å®šåå°†æ€»ç»“å½“å‰å¯¹è¯å¹¶è‡ªåŠ¨å¯¼å‡ºã€‚');
      setTimeout(doSend, 50);
      
      var getVisibleStopBtn = function() {
        var icon = document.querySelector('mat-icon[data-mat-icon-name="stop"], mat-icon[data-mat-icon-name="stop_circle"]');
        if (icon) {
          var btn = icon.closest('button');
          if (btn && btn.getBoundingClientRect().width > 0) return btn;
        }
        var byLabel = document.querySelector('button[aria-label*="åœæ­¢"], button[aria-label*="Stop"], [aria-label*="åœæ­¢"]');
        if (byLabel) {
          var b = byLabel.tagName === 'BUTTON' ? byLabel : byLabel.closest('button');
          if (b && b.getBoundingClientRect().width > 0) return b;
        }
        return null;
      };
      var stopButtonSeen = false;
      var startTime = Date.now();
      
      var check = function() {
        var elapsed = Date.now() - startTime;
        var stopBtn = getVisibleStopBtn();
        if (stopBtn) stopButtonSeen = true;
        if (stopButtonSeen && !stopBtn) {
          doExport('æŒ‰é’®æ£€æµ‹ï¼ˆåœæ­¢æŒ‰é’®æ¶ˆå¤±ï¼‰');
          return;
        }
        if (elapsed > MAX_GENERATING_MS) {
          alert('ç­‰å¾…è¶…æ—¶ï¼ˆ3åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º');
          return;
        }
        if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) {
          doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰');
          return;
        }
        setTimeout(check, POLL_MS);
      };
      setTimeout(check, POLL_MS);
    };
    
    document.getElementById('sender').href = 'javascript:(' + script.toString() + ')();';
  </script>
</body>
</html>
