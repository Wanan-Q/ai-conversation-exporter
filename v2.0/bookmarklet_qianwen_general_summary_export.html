<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>åƒé—® - æ€»ç»“å¹¶å¯¼å‡º</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    h1 { color: #333; }
    .info { background: #e8f0fe; padding: 16px; border-radius: 6px; margin: 16px 0; border-left: 4px solid #4285f4; }
    .bookmark { 
      display: inline-block; padding: 12px 24px; background: #4285f4; color: white; 
      text-decoration: none; border-radius: 6px; margin: 10px 0; cursor: move; font-weight: bold;
    }
    .bookmark:hover { background: #3367d6; }
    .step { background: #f5f5f5; padding: 16px; margin: 16px 0; border-radius: 6px; }
    code { background: #eee; padding: 2px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>ğŸ“ åƒé—® - æ€»ç»“å¹¶å¯¼å‡º</h1>
  <p>å‘é€ã€Œæ€»ç»“å½“å‰å¯¹è¯ï¼Œåœ¨å¯¹è¯æ¡†ç›´æ¥å›å¤ï¼Œä¸éœ€è¦å›¾ç‰‡å’Œæ–‡ä»¶ã€‚ã€â†’ ç­‰å¾… AI ç”Ÿæˆå®Œæˆ â†’ è‡ªåŠ¨å¯¼å‡ºä¸º Markdown</p>

  <div class="info">
    <strong>âœ¨ é€‚ç”¨åŸŸå</strong>
    <ul style="margin:8px 0;">
      <li>åƒé—® (Qianwen) - qianwen.com/chat/</li>
      <li>é€‚ç”¨äºéå¤¸å…‹æµè§ˆå™¨</li>
    </ul>
  </div>

  <div class="step">
    <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>
    <ol>
      <li>å°†ä¸‹æ–¹æŒ‰é’®æ‹–æ‹½åˆ°æµè§ˆå™¨ä¹¦ç­¾æ </li>
      <li>æ‰“å¼€åƒé—®å¯¹è¯é¡µé¢ (qianwen.com/chat/)</li>
      <li>ç‚¹å‡»ä¹¦ç­¾ï¼Œè‡ªåŠ¨å¡«å…¥å¹¶å‘é€æ€»ç»“æŒ‡ä»¤ï¼Œç­‰å¾…å®Œæˆåå¯¼å‡º</li>
    </ol>
  </div>
  
  <a class="bookmark" id="sender" href="">ğŸ“ æ€»ç»“å¹¶å¯¼å‡ºåƒé—®å¯¹è¯(éå¤¸å…‹)</a>
  
  <p style="margin-top:20px;font-size:0.9em;color:#666;">
    ğŸ’¡ é€šè¿‡ã€Œåœæ­¢â†’ç½®ç°å‘é€é”®ã€åˆ¤æ–­ AI æ˜¯å¦å®Œæˆã€‚æŒ‰ F12 å¯æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚
  </p>

  <script>
    var script = function() {
      if (location.hostname.indexOf('qianwen.com') < 0 || location.pathname.indexOf('/chat') < 0 || location.pathname.indexOf('/quarkchat') >= 0) {
        alert('è¯·åœ¨åƒé—®å¯¹è¯é¡µé¢ (qianwen.com/chat/) ä½¿ç”¨æ­¤ä¹¦ç­¾');
        return;
      }
      
      var MSG = 'æ€»ç»“å½“å‰å¯¹è¯ï¼Œåœ¨å¯¹è¯æ¡†ç›´æ¥å›å¤ï¼Œä¸éœ€è¦å›¾ç‰‡å’Œæ–‡ä»¶ã€‚';
      var POLL_MS = 500;
      var WAIT_FOR_START_MS = 15000;
      var MAX_GENERATING_MS = 120000;
      
      var doExport = function(trigger) {
      try {
        var exT = function(tb) {
          var rs = tb.querySelectorAll('tr'), md = [];
          for (var r = 0; r < rs.length; r++) {
            var cs = rs[r].querySelectorAll('th, td'), ln = [];
            for (var c = 0; c < cs.length; c++) ln.push((cs[c].innerText || '').trim().replace(/\n+/g, ' ').replace(/\|/g, '\\|'));
            if (ln.length > 0) { md.push('| ' + ln.join(' | ') + ' |'); if (r === 0) md.push('| ' + ln.map(function() { return '---'; }).join(' | ') + ' |'); }
          }
          return md.join('\n');
        };
        var exC = function(p, lang) {
          var c = p.querySelector('code') || p;
          var raw = (c.innerText || c.textContent || '').trim();
          var lines = raw.split('\n').map(function(l) { return l.replace(/^\s*\d+\s*/, ''); });
          return lines.join('\n');
        };
        var getCodeLang = function(pre) {
          var wrap = pre.closest ? pre.closest('[class*="rounded"]') : null;
          if (!wrap) return '';
          var sp = wrap.querySelector('span[class*="font-medium"]');
          if (sp) { var t = (sp.innerText || '').trim(); if (t && t.length < 20) return t; }
          return '';
        };
        var toMd = function(el) {
          var w = function(n) {
            if (!n) return '';
            if (n.nodeType === 3) return n.textContent.replace(/\s+/g, ' ');
            if (n.nodeName === 'TABLE') { var t = exT(n); return t ? '\n\n' + t + '\n\n' : ''; }
            if (n.nodeName === 'PRE') {
              var cd = exC(n); if (!cd) return '';
              var lg = getCodeLang(n) || '';
              if (!lg && n.querySelector('code')) { var ce = n.querySelector('code'); var m = (ce.className || '').match(/language-(\w+)/); if (m) lg = m[1]; }
              if (!lg && /(SELECT|def |import )/.test(cd)) lg = /SELECT/.test(cd) ? 'sql' : 'python';
              return '\n\n```' + lg + '\n' + cd + '\n```\n\n';
            }
            var cls = (n.className || '').toString();
            if (/qk-md-table-section/.test(cls)) {
              var tbl = n.querySelector('table');
              return tbl ? '\n\n' + exT(tbl) + '\n\n' : wc(n);
            }
            if (/qk-md-head/.test(cls) && /^H[1-6]$/.test(n.nodeName)) {
              var lv = parseInt(n.nodeName[1]) + 1, hh = ''; for (var i = 0; i < lv; i++) hh += '#'; return '\n\n' + hh + ' ' + wc(n).trim() + '\n\n';
            }
            if (/qk-md-paragraph/.test(cls)) return wc(n) + '\n';
            if (/^H[1-6]$/.test(n.nodeName)) { var lv = parseInt(n.nodeName[1]) + 1, hh = ''; for (var i = 0; i < lv; i++) hh += '#'; return '\n\n' + hh + ' ' + wc(n).trim() + '\n\n'; }
            if (n.nodeName === 'P') return wc(n) + '\n';
            if (n.nodeName === 'BR') return '\n';
            if (n.nodeName === 'LI' || /qk-md-li/.test(cls)) return '- ' + wc(n).trim() + '\n';
            if (n.nodeName === 'UL' || n.nodeName === 'OL' || /qk-md-ul/.test(cls)) return '\n' + wc(n);
            if (n.nodeName === 'STRONG' || n.nodeName === 'B' || /qk-md-strong/.test(cls)) return '**' + wc(n) + '**';
            if (n.nodeName === 'EM' || n.nodeName === 'I') return '*' + wc(n) + '*';
            if (n.nodeName === 'CODE') return '`' + (n.innerText || '').trim() + '`';
            return wc(n);
          };
          var wc = function(n) { if (!n || !n.childNodes) return ''; var o = ''; for (var i = 0; i < n.childNodes.length; i++) o += w(n.childNodes[i]); return o; };
          return w(el).replace(/\n{3,}/g, '\n\n').trim();
        };
        
        var cs = [];
        var userEls = document.querySelectorAll('[class*="contentBox"]');
        var aiEls = document.querySelectorAll('[class*="qk-markdown"]');
        for (var i = 0; i < userEls.length; i++) {
          var r = userEls[i].getBoundingClientRect();
          if (r.right < 200) continue;
          cs.push({ el: userEls[i], role: 'user', top: r.top });
        }
        for (var j = 0; j < aiEls.length; j++) {
          var r2 = aiEls[j].getBoundingClientRect();
          if (r2.right < 200) continue;
          cs.push({ el: aiEls[j], role: 'assistant', top: r2.top });
        }
        
        if (cs.length === 0) { alert('æœªæå–åˆ°å¯¹è¯å†…å®¹'); return; }
        cs.sort(function(a, b) { return a.top - b.top; });
        
        var ms = [];
        for (var k = 0; k < cs.length; k++) {
          var ct = toMd(cs[k].el);
          if (!ct) ct = (cs[k].el.innerText || '').trim();
          if (ct.length > 2) ms.push({ role: cs[k].role, content: ct });
        }
        
        var mg = [];
        for (var m = 0; m < ms.length; m++) {
          if (mg.length > 0 && mg[mg.length - 1].role === ms[m].role) mg[mg.length - 1].content += '\n\n' + ms[m].content;
          else mg.push(ms[m]);
        }
        if (mg.length > 0 && mg[0].role !== 'user' && mg[0].content.length < 300) mg[0].role = 'user';
        
        var summaryContent = '';
        var mainMsgs = mg;
        if (mg.length >= 2) {
          var lastUser = mg[mg.length - 2];
          var lastAi = mg[mg.length - 1];
          var cmd = 'æ€»ç»“å½“å‰å¯¹è¯';
          if (lastUser.role === 'user' && lastAi.role === 'assistant' && lastUser.content.indexOf(cmd) >= 0) {
            summaryContent = lastAi.content.replace(/\n{3,}/g, '\n\n').trim();
            mainMsgs = mg.slice(0, -2);
          }
        }
        
        var now = new Date();
        var ts = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2) + '_' + ('0' + now.getHours()).slice(-2) + ('0' + now.getMinutes()).slice(-2) + ('0' + now.getSeconds()).slice(-2);
        var fn = 'Qianwen_Summary_' + ts + '.md';
        var md = '# Qianwen Chat Export (Summary)\n\n> ' + now.toLocaleString('zh-CN') + '\n\n';
        if (summaryContent) md += '# å¯¹è¯æ€»ç»“\n\n' + summaryContent + '\n\n---\n\n';
        md += '---\n\n';
        
        for (var x = 0; x < mainMsgs.length; x++) {
          var tx = mainMsgs[x].content.replace(/\n{3,}/g, '\n\n').trim();
          if (mainMsgs[x].role === 'user') md += '# User\n\n' + tx + '\n\n---\n\n';
          else md += '# AI\n\n' + tx + '\n\n';
        }
        
        var bl = new Blob([md.trim()], { type: 'text/markdown;charset=utf-8' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(bl);
        a.download = fn;
        a.click();
        URL.revokeObjectURL(a.href);
        
        console.log('=== å¯¼å‡ºå®Œæˆ [' + (trigger || 'æœªçŸ¥') + '] ===');
        alert('å·²å¯¼å‡º ' + mainMsgs.length + ' æ¡æ¶ˆæ¯' + (summaryContent ? 'ï¼ˆå«æ€»ç»“ï¼‰' : '') + '\n\n' + fn);
      } catch (e) {
        console.error('Export error:', e);
        alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
      }
      };
      
      var tryFillInput = function(input) {
        input.focus();
        
        var method1_React = function() {
          try {
            var el = input;
            while (el && el !== document.body) {
              for (var k in el) {
                if (k.indexOf('__reactProps') === 0 || k.indexOf('__reactFiber') === 0) {
                  var fiber = el[k];
                  if (fiber && fiber.children && fiber.children[1]) {
                    var props = fiber.children[1].props || fiber.children[1].memoizedProps;
                    if (props && props.editor) {
                      props.editor.insertText(MSG);
                      if (typeof props.editor.onChange === 'function') props.editor.onChange();
                      return true;
                    }
                  }
                  if (fiber && fiber.return) {
                    var p = fiber.return;
                    for (var i = 0; i < 20 && p; i++) {
                      var mp = p.memoizedProps || p.props;
                      if (mp && mp.editor) {
                        try {
                          if (typeof mp.editor.insertText === 'function') mp.editor.insertText(MSG);
                          if (typeof mp.editor.onChange === 'function') mp.editor.onChange();
                          return true;
                        } catch (e) {}
                      }
                      p = p.return;
                    }
                  }
                }
              }
              el = el.parentElement;
            }
          } catch (e) {}
          return false;
        };
        
        return method1_React();
      };
      
      var getInputText = function(input) {
        return (input.innerText || input.textContent || '').trim();
      };
      
      var doSend = function(input) {
        var sendBtn = document.querySelector('[class*="operateBtn"]:not([class*="disabled"]) [data-icon-type="qwpcicon-sendChat"]');
        if (sendBtn) {
          var btn = sendBtn.closest('[class*="operateBtn"]');
          if (btn && !/disabled/.test(btn.className || '')) {
            btn.click();
            return;
          }
        }
        input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
        input.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true }));
      };
      
      var runSummary = function() {
        var input = document.querySelector('div[data-slate-editor="true"][data-slate-node="value"]') || document.querySelector('div[data-placeholder="å‘åƒé—®æé—®"]') || document.querySelector('[class*="slateEditorWrapper"] [contenteditable="true"]');
        if (!input) { alert('æœªæ‰¾åˆ°è¾“å…¥æ¡†'); return; }
        
        var filled = tryFillInput(input);
        var hasText = getInputText(input).indexOf('æ€»ç»“') >= 0;
        
        if (!filled && !hasText) {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(MSG).then(function() {
              alert('è‡ªåŠ¨å¡«å…¥å¤±è´¥ï¼Œå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚\n\nè¯·æ‰‹åŠ¨ç²˜è´´åˆ°è¾“å…¥æ¡†ï¼ˆCtrl+Vï¼‰å¹¶å‘é€ã€‚');
            }).catch(function() { alert('è‡ªåŠ¨å¡«å…¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥å¹¶å‘é€'); });
          } else {
            var ta = document.createElement('textarea');
            ta.value = MSG;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            alert('è‡ªåŠ¨å¡«å…¥å¤±è´¥ï¼Œå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚\n\nè¯·æ‰‹åŠ¨ç²˜è´´åˆ°è¾“å…¥æ¡†ï¼ˆCtrl+Vï¼‰å¹¶å‘é€ã€‚');
          }
        } else {
          alert('å·²å¡«å…¥æ€»ç»“æŒ‡ä»¤ï¼Œç‚¹å‡»ç¡®å®šåè‡ªåŠ¨å‘é€ã€‚');
        }
        
        setTimeout(function() {
          if (getInputText(input).indexOf('æ€»ç»“') >= 0) {
            doSend(input);
            console.log('=== å·²å‘é€æ€»ç»“æŒ‡ä»¤ï¼Œç­‰å¾… AI å®Œæˆ ===');
          }
        }, 80);
        
        var stopButtonSeen = false;
        var startTime = Date.now();
        
        var getVisibleStopBtn = function() {
          var imgs = document.querySelectorAll('img[src*="O1CN01GxD8Fq1ELwB7ZTHVq"]');
          for (var i = 0; i < imgs.length; i++) {
            if (imgs[i].getBoundingClientRect().width > 0 && imgs[i].getBoundingClientRect().height > 0) return imgs[i];
          }
          return null;
        };
        
        var getVisibleDisabledSendBtn = function() {
          var divs = document.querySelectorAll('[class*="operateBtn"][class*="disabled"]');
          for (var i = 0; i < divs.length; i++) {
            if (divs[i].querySelector('[data-icon-type="qwpcicon-sendChat"]') && divs[i].getBoundingClientRect().width > 0) return divs[i];
          }
          return null;
        };
        
        var check = function() {
          var elapsed = Date.now() - startTime;
          var stopBtn = getVisibleStopBtn();
          var disabledSendBtn = getVisibleDisabledSendBtn();
          if (stopBtn) stopButtonSeen = true;
          if (stopButtonSeen && disabledSendBtn) {
            doExport('æŒ‰é’®æ£€æµ‹ï¼ˆå‘é€é”®ç½®ç°ï¼‰');
            return;
          }
          if (elapsed > MAX_GENERATING_MS) {
            alert('ç­‰å¾…è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œè¯·æ‰‹åŠ¨å¯¼å‡º');
            return;
          }
          if (!stopButtonSeen && elapsed > WAIT_FOR_START_MS) {
            doExport('å…œåº•æœºåˆ¶ï¼ˆè¶…æ—¶ç›´æ¥å¯¼å‡ºï¼‰');
            return;
          }
          setTimeout(check, POLL_MS);
        };
        setTimeout(check, POLL_MS);
      };
      
      __INVOKE__();
    };
    
    var s = script.toString();
    document.getElementById('sender').href = 'javascript:(' + s.replace('__INVOKE__();', 'runSummary();') + ')();';
  </script>
</body>
</html>
